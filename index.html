<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clover Pit - Debt Cycle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --bg-color: #111;
            --cell-bg: #222;
            --panel-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --highlight-color: #00ff7f;
            --danger-color: #ff3b3b;
            --money-color: #ffd700;
            --ticket-color: #b388ff;
            --luck-color: #40c4ff;
            --border-color: #444;
            --rarity-common: #aaa;
            --rarity-rare: #536dfe;
            --rarity-legendary: #ffab40;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Roboto Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .game-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            width: 100%;
            max-width: 1300px;
        }

        .main-panel {
            flex-grow: 1; display: flex; flex-direction: column; gap: 20px;
        }
        
        .slot-area {
            display: flex;
            align-items: stretch;
            gap: 20px;
        }

        .slot-machine {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 15px;
            border: 2px solid var(--border-color);
            background-color: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            flex-grow: 1;
        }

        .slot-cell {
            background-color: var(--cell-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1 / 1;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .slot-cell .reel {
            /* transition —É–±—Ä–∞–Ω –æ—Ç—Å—é–¥–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ JS */
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2000%; /* 20 –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
        }
        .slot-cell .symbol {
            width: 100%; 
            height: 5%; /* 1/20 */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 2em;
            padding: 10%;
        }

        .slot-cell.highlight {
            box-shadow: 0 0 15px var(--highlight-color);
            border-color: var(--highlight-color);
            transform: scale(1.05);
            z-index: 10;
            animation: winPulse 0.5s ease-in-out;
        }
        .slot-cell.highlight-big {
            box-shadow: 0 0 20px var(--money-color);
            border-color: var(--money-color);
            transform: scale(1.08);
            z-index: 10;
            animation: winPulseBig 0.5s ease-in-out;
        }
        .slot-cell.highlight-huge {
            box-shadow: 0 0 25px var(--ticket-color);
            border-color: var(--ticket-color);
            transform: scale(1.12);
            z-index: 10;
            animation: winPulseHuge 0.5s ease-in-out;
        }


        .lever-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--panel-bg); border: 2px solid var(--border-color);
            padding: 20px 15px; border-radius: 8px;
        }
        .lever-base { width: 50px; height: 30px; background: #333; border-radius: 5px 5px 0 0; }
        .lever {
            width: 12px; height: 100px; background: #666;
            position: relative; cursor: pointer; transition: transform 0.2s;
            transform-origin: bottom center;
        }
        .lever-handle {
            width: 30px; height: 30px; background: var(--danger-color);
            border-radius: 50%; position: absolute; top: -15px; left: -9px;
        }
        .lever.pulled { transform: rotate(45deg); cursor: not-allowed; }
        .lever:not(.pulled):hover { transform: scale(1.1); }

        .controls {
            padding: 15px; border: 2px solid var(--border-color); background-color: var(--panel-bg);
            border-radius: 8px; text-align: center;
            display: flex; justify-content: space-around; align-items: center;
        }

        .log-panel {
            height: 150px; padding: 15px; border: 2px solid var(--border-color);
            background-color: var(--panel-bg); border-radius: 8px; overflow-y: auto;
            font-size: 14px; display: flex; flex-direction: column-reverse;
        }
        .log-panel p { margin-bottom: 5px; }

        .ui-panel {
            width: 350px; display: flex; flex-direction: column;
            gap: 20px; flex-shrink: 0;
        }

        .ui-box {
            padding: 15px; border: 2px solid var(--border-color);
            background-color: var(--panel-bg); border-radius: 8px;
        }
        .ui-box h3 {
            margin-bottom: 10px; border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px; color: var(--highlight-color);
        }

        .stats-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px; }
        .stats-grid span:nth-child(odd) { text-align: left; padding-right: 10px; font-weight: 700; }
        .shop-items, .inventory-items { display: flex; flex-direction: column; gap: 10px; max-height: 150px; overflow-y: auto; padding-right: 5px; }

        .item {
            padding: 10px; border: 1px solid var(--border-color); background-color: var(--cell-bg);
            border-radius: 4px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
            position: relative;
        }
        .item:hover:not(:disabled) { background-color: #3c3c3c; border-color: var(--highlight-color); }
        .item.rarity-common { border-left: 5px solid var(--rarity-common); }
        .item.rarity-rare { border-left: 5px solid var(--rarity-rare); }
        .item.rarity-legendary { border-left: 5px solid var(--rarity-legendary); }
        
        .item-name { font-weight: bold; }
        .item-cost { float: right; color: var(--ticket-color); font-weight: bold; }
        .item-desc { font-size: 12px; color: #aaa; margin-top: 5px; }
        
        .atm-actions { display: flex; gap: 10px; margin-top: 10px; }
        .atm-actions input {
            flex-grow: 1; background-color: var(--cell-bg); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 8px; font-family: 'Roboto Mono', monospace; border-radius: 4px;
            width: 50%;
        }

        button {
            font-family: 'Roboto Mono', monospace; padding: 10px 20px;
            border: 1px solid var(--border-color); background-color: var(--cell-bg);
            color: var(--text-color); cursor: pointer; border-radius: 4px;
            font-size: 16px; transition: all 0.2s;
        }
        button:hover:not(:disabled) { background-color: var(--highlight-color); color: var(--bg-color); border-color: var(--highlight-color); }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        
        #btn-end-turn, #btn-confirm-end-turn { background-color: var(--danger-color); border-color: #ff6b6b; }
        #btn-end-turn:hover:not(:disabled), #btn-confirm-end-turn:hover:not(:disabled) { background-color: #ff6b6b; border-color: white; color: white; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); display: flex; justify-content: center;
            align-items: center; z-index: 1000; text-align: center; padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--panel-bg); padding: 30px; border-radius: 8px;
            border: 2px solid var(--border-color); max-width: 500px;
        }
        .modal-content h2 { margin-bottom: 15px; color: var(--highlight-color); }
        .modal-content p { margin-bottom: 25px; }
        .modal-content button { margin: 5px; }
        .modal-stats { text-align: left; max-width: 300px; margin: 20px auto; display: grid; grid-template-columns: auto 1fr; gap: 8px;}
        #game-over-screen .modal-content h2, #judgement-modal .modal-content h2.failure { color: var(--danger-color); }
        .hidden { display: none; }
        .shake { animation: shake 0.5s infinite; }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-2px, -2px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translate(2px, 2px) rotate(1deg); }
        }
        @keyframes winPulse { 0% {transform: scale(1.05);} 50% {transform: scale(1.1);} 100% {transform: scale(1.05);} }
        @keyframes winPulseBig { 0% {transform: scale(1.08);} 50% {transform: scale(1.15);} 100% {transform: scale(1.08);} }
        @keyframes winPulseHuge { 0% {transform: scale(1.12);} 50% {transform: scale(1.2);} 100% {transform: scale(1.12);} }
    </style>
</head>
<body>

    <div class="game-container">
        <div class="main-panel">
            <div class="slot-area">
                <div id="slot-machine" class="slot-machine"></div>
                <div class="lever-container">
                    <div id="lever" class="lever"><div class="lever-handle"></div></div>
                    <div class="lever-base"></div>
                </div>
            </div>
            <div class="controls">
                <span>–ü—Ä–æ–∫—Ä—É—Ç–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: <span id="spins-left">0</span></span>
                <button id="btn-end-turn">–ó–∞–∫–æ–Ω—á–∏—Ç—å —Ä–∞—É–Ω–¥</button>
            </div>
            <div class="log-panel" id="log-panel"></div>
        </div>

        <div class="ui-panel">
            <div class="ui-box">
                <h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
                <div class="stats-grid">
                    <span>–¶–∏–∫–ª –î–æ–ª–≥–∞:</span><span id="stat-run">1</span>
                    <span>–†–∞—É–Ω–¥:</span><span id="stat-turn">1 / 3</span>
                    <span style="color: var(--danger-color);">–¶–ï–õ–¨:</span><span id="stat-debt" style="color: var(--danger-color);">50</span>
                    <span style="color: var(--money-color);">–ù–∞–ª–∏—á–Ω—ã–µ:</span><span id="stat-coins" style="color: var(--money-color);">0</span>
                    <span style="color: var(--ticket-color);">–¢–∞–ª–æ–Ω—ã:</span><span id="stat-tickets" style="color: var(--ticket-color);">0</span>
                    <span style="color: var(--luck-color);">–£–¥–∞—á–∞:</span><span id="stat-luck" style="color: var(--luck-color);">0</span>
                </div>
            </div>
            <div class="ui-box">
                <h3>–ë–∞–Ω–∫</h3>
                <div class="stats-grid">
                    <span>–ë–∞–ª–∞–Ω—Å:</span><span id="bank-balance" style="color: var(--money-color);">0</span>
                    <span>–°—Ç–∞–≤–∫–∞:</span><span><span id="atm-interest-rate">3</span>%</span>
                </div>
                <div class="atm-actions">
                    <input type="number" id="deposit-amount" placeholder="–°—É–º–º–∞">
                    <button id="btn-deposit">–í–Ω–µ—Å—Ç–∏</button>
                </div>
            </div>
            <div class="ui-box">
                <h3>–ú–∞–≥–∞–∑–∏–Ω <button id="btn-reroll-shop" style="float: right; font-size: 12px; padding: 5px 8px;">Reroll (2üéüÔ∏è)</button></h3>
                <div id="shop-items" class="shop-items"></div>
            </div>
            <div class="ui-box">
                <h3>–ê–º—É–ª–µ—Ç—ã</h3>
                <div id="inventory-items" class="inventory-items"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="start-screen" class="modal-overlay">
        <div class="modal-content">
            <h2>Clover Pit</h2>
            <p>–£ –≤–∞—Å –µ—Å—Ç—å 3 —Ä–∞—É–Ω–¥–∞ (–¥–Ω—è), —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å—É–º–º—É –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã –¥–æ–ª–≥–∞. –í–Ω–æ—Å–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –≤ –±–∞–Ω–∫, –ø–æ–∫—É–ø–∞–π—Ç–µ –ø—Ä–æ–∫—Ä—É—Ç—ã –∏ –∞–º—É–ª–µ—Ç—ã, –∏ –º–æ–ª–∏—Ç–µ—Å—å –æ–± —É–¥–∞—á–µ. –ï—Å–ª–∏ –∫ –∫–æ–Ω—Ü—É 3-–≥–æ –¥–Ω—è —É –≤–∞—Å –Ω–µ –±—É–¥–µ—Ç –Ω—É–∂–Ω–æ–π —Å—É–º–º—ã... –≤—ã –ø—Ä–æ–≤–∞–ª–∏—Ç–µ—Å—å –≤ —è–º—É.</p>
            <button id="btn-start-game">–ù–∞—á–∞—Ç—å</button>
        </div>
    </div>
    <div id="game-over-screen" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="shake">–í–´ –ü–†–û–í–ê–õ–ò–õ–ò–°–¨ –í –Ø–ú–£</h2>
            <p>–°—É–¥–Ω—ã–π –¥–µ–Ω—å –Ω–∞—Å—Ç–∞–ª, –∞ –¥–µ–Ω–µ–≥ –Ω–µ—Ç. –¢—å–º–∞ –ø–æ–≥–ª–æ—â–∞–µ—Ç –≤–∞—Å.</p>
            <p>–í—ã –ø—Ä–æ–¥–µ—Ä–∂–∞–ª–∏—Å—å: <span id="final-run"></span> —Ü–∏–∫–ª(–æ–≤).</p>
            <button id="btn-restart-game">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>
    <div id="spin-purchase-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="purchase-modal-title">–†–∞—É–Ω–¥ 1. –í—Ä–µ–º—è –∑–∞–∫—É–ø–∞—Ç—å—Å—è.</h2>
            <p>–í–∞—à–∏ –Ω–∞–ª–∏—á–Ω—ã–µ: <span id="purchase-modal-coins" style="color: var(--money-color)">0</span>. –í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç–µ –¥–µ–Ω—å–≥–∏ —Å–µ–≥–æ–¥–Ω—è.</p>
            <button id="buy-spins-7">7 –ø—Ä–æ–∫—Ä—É—Ç–æ–≤ + 1 —Ç–∞–ª–æ–Ω (–°—Ç–æ–∏–º–æ—Å—Ç—å: 10üí∞)</button>
            <button id="buy-spins-3">3 –ø—Ä–æ–∫—Ä—É—Ç–∞ + 2 —Ç–∞–ª–æ–Ω–∞ (–°—Ç–æ–∏–º–æ—Å—Ç—å: 7üí∞)</button>
            <button id="buy-nothing">–ù–∏—á–µ–≥–æ. –Ø —Å–ø—Ä–∞–≤–ª—é—Å—å.</button>
            <button id="btn-planning" style="margin-top: 10px; background-color: var(--ticket-color); border-color: var(--ticket-color);">üìã –†–µ–∂–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
        </div>
    </div>
    <!-- –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –†–ï–ñ–ò–ú–ê –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–Ø -->
    <div id="planning-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h2>üìã –†–µ–∂–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <p>–ü–æ–∫—É–ø–∞–π—Ç–µ –∞–º—É–ª–µ—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–≤–æ–∏—Ö —à–∞–Ω—Å–æ–≤.</p>
            
            <div style="text-align: center; margin: 15px 0; padding: 10px; background-color: var(--cell-bg); border-radius: 4px; border: 1px solid var(--border-color);">
                <span style="color: var(--ticket-color); font-weight: bold;">–í–∞—à–∏ —Ç–∞–ª–æ–Ω—ã: <span id="planning-tickets">0</span>üéüÔ∏è</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div>
                    <h3 style="color: var(--ticket-color);">–ú–∞–≥–∞–∑–∏–Ω –∞–º—É–ª–µ—Ç–æ–≤</h3>
                    <div id="planning-shop-items" class="shop-items" style="max-height: 300px;"></div>
                    <button id="btn-planning-reroll" style="margin-top: 10px; font-size: 12px; padding: 5px 8px;">Reroll (2üéüÔ∏è)</button>
                </div>
                <div>
                    <h3 style="color: var(--highlight-color);">–í–∞—à–∏ –∞–º—É–ª–µ—Ç—ã</h3>
                    <div id="planning-inventory-items" class="inventory-items" style="max-height: 300px;"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="btn-finish-planning">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            </div>
        </div>
    </div>
    <div id="end-of-round-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="eor-title">–ö–æ–Ω–µ—Ü –†–∞—É–Ω–¥–∞</h2>
            <p>–î–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É. –í–Ω–µ—Å–∏—Ç–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è –≤ –±–∞–Ω–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞—É–Ω–¥–µ.</p>
            <div class="modal-stats">
                <span>–ù–∞–ª–∏—á–Ω—ã–µ:</span><span id="eor-coins" style="color: var(--money-color)"></span>
                <span>–í –±–∞–Ω–∫–µ:</span><span id="eor-bank" style="color: var(--money-color)"></span>
            </div>
            <div class="atm-actions" style="justify-content: center; max-width: 300px; margin: 20px auto;">
                <input type="number" id="eor-deposit-amount" placeholder="–°—É–º–º–∞ –≤–∫–ª–∞–¥–∞">
                <button id="btn-eor-deposit">–í–Ω–µ—Å—Ç–∏</button>
            </div>
            <button id="btn-confirm-end-turn">–ó–∞–≤–µ—Ä—à–∏—Ç—å –†–∞—É–Ω–¥</button>
        </div>
    </div>
    <div id="judgement-modal" class="modal-overlay hidden">
         <div class="modal-content">
            <h2 id="judgement-title">–°–£–î–ù–´–ô –î–ï–ù–¨</h2>
            <p id="judgement-text">...–ø–æ–¥—Å—á–µ—Ç –æ–∫–æ–Ω—á–µ–Ω...</p>
            <button id="judgement-continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
    
        <script>
    document.addEventListener('DOMContentLoaded', () => {
        const ui = {
            slotMachine: document.getElementById('slot-machine'),
            lever: document.getElementById('lever'),
            spinsLeft: document.getElementById('spins-left'),
            logPanel: document.getElementById('log-panel'),
            statRun: document.getElementById('stat-run'),
            statTurn: document.getElementById('stat-turn'),
            statCoins: document.getElementById('stat-coins'),
            statTickets: document.getElementById('stat-tickets'),
            statLuck: document.getElementById('stat-luck'),
            statDebt: document.getElementById('stat-debt'),
            bankBalance: document.getElementById('bank-balance'),
            atmInterestRate: document.getElementById('atm-interest-rate'),
            depositAmountInput: document.getElementById('deposit-amount'),
            btnDeposit: document.getElementById('btn-deposit'),
            shopItems: document.getElementById('shop-items'),
            btnRerollShop: document.getElementById('btn-reroll-shop'),
            inventoryItems: document.getElementById('inventory-items'),
            btnEndTurn: document.getElementById('btn-end-turn'),
            startScreen: document.getElementById('start-screen'),
            gameOverScreen: document.getElementById('game-over-screen'),
            spinPurchaseModal: document.getElementById('spin-purchase-modal'),
            purchaseModalTitle: document.getElementById('purchase-modal-title'),
            purchaseModalCoins: document.getElementById('purchase-modal-coins'),
            btnBuySpins7: document.getElementById('buy-spins-7'),
            btnBuySpins3: document.getElementById('buy-spins-3'),
            btnBuyNothing: document.getElementById('buy-nothing'),
            btnPlanning: document.getElementById('btn-planning'),
            planningModal: document.getElementById('planning-modal'),
            planningShopItems: document.getElementById('planning-shop-items'),
            planningInventoryItems: document.getElementById('planning-inventory-items'),
            planningTickets: document.getElementById('planning-tickets'),
            btnPlanningReroll: document.getElementById('btn-planning-reroll'),
            btnFinishPlanning: document.getElementById('btn-finish-planning'),
            judgementModal: document.getElementById('judgement-modal'),
            judgementTitle: document.getElementById('judgement-title'),
            judgementText: document.getElementById('judgement-text'),
            judgementContinue: document.getElementById('judgement-continue'),
            finalRun: document.getElementById('final-run'),
            btnStartGame: document.getElementById('btn-start-game'),
            btnRestartGame: document.getElementById('btn-restart-game'),
            endOfRoundModal: document.getElementById('end-of-round-modal'),
            eorTitle: document.getElementById('eor-title'),
            eorCoins: document.getElementById('eor-coins'),
            eorBank: document.getElementById('eor-bank'),
            eorDepositAmount: document.getElementById('eor-deposit-amount'),
            btnEorDeposit: document.getElementById('btn-eor-deposit'),
            btnConfirmEndTurn: document.getElementById('btn-confirm-end-turn'),
        };

        const CONFIG = {
            ROWS: 3, COLS: 5, REROLL_COST: 2,
            SPIN_ANIMATION_TIME: 1200, 
            SPIN_PACKAGE_1: { spins: 7, tickets: 1, cost: 10 },
            SPIN_PACKAGE_2: { spins: 3, tickets: 2, cost: 7 },
        };
        const GRAPHICS = {
            lemon: 'üçã', cherry: 'üçí', clover: 'üçÄ', bell: 'üîî', diamond: 'üíé', coins: 'üí∞', seven: '7Ô∏è‚É£',
        };
        const SYMBOLS = [
            { id: 'lemon',    value: 2, weight: 25, graphic: GRAPHICS.lemon }, { id: 'cherry',   value: 2, weight: 25, graphic: GRAPHICS.cherry },
            { id: 'clover',   value: 3, weight: 20, graphic: GRAPHICS.clover }, { id: 'bell',     value: 3, weight: 20, graphic: GRAPHICS.bell },
            { id: 'diamond',  value: 5, weight: 15, graphic: GRAPHICS.diamond }, { id: 'coins',    value: 5, weight: 15, graphic: GRAPHICS.coins },
            { id: 'seven',    value: 7, weight: 7,  graphic: GRAPHICS.seven },
        ];
        const PAYLINES = [
            { name: "–í–µ—Ä—Ö–Ω—è—è –ª–∏–Ω–∏—è", positions: [0, 1, 2, 3, 4] }, { name: "–°—Ä–µ–¥–Ω—è—è –ª–∏–Ω–∏—è", positions: [5, 6, 7, 8, 9] },
            { name: "–ù–∏–∂–Ω—è—è –ª–∏–Ω–∏—è", positions: [10, 11, 12, 13, 14] }, { name: "V", positions: [0, 6, 12, 8, 4] },
            { name: "–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è V", positions: [10, 6, 2, 8, 14] },
            { name: "–ö–æ–ª–æ–Ω–∫–∞ 1", positions: [0, 5, 10] }, { name: "–ö–æ–ª–æ–Ω–∫–∞ 2", positions: [1, 6, 11] },
            { name: "–ö–æ–ª–æ–Ω–∫–∞ 3", positions: [2, 7, 12] }, { name: "–ö–æ–ª–æ–Ω–∫–∞ 4", positions: [3, 8, 13] },
            { name: "–ö–æ–ª–æ–Ω–∫–∞ 5", positions: [4, 9, 14] },
        ];
        const ALL_ITEMS = [
            { id: 'lucky_clover', name: '–°—á–∞—Å—Ç–ª–∏–≤—ã–π –∫–ª–µ–≤–µ—Ä', desc: '+1 –∫ —É–¥–∞—á–µ', cost: 3, rarity: 'common', effect: { luck: 1 } },
            { id: 'golden_ticket', name: '–ó–æ–ª–æ—Ç–æ–π –±–∏–ª–µ—Ç', desc: '+2 –∫ —É–¥–∞—á–µ', cost: 5, rarity: 'rare', effect: { luck: 2 } },
            { id: 'fortune_charm', name: '–ê–º—É–ª–µ—Ç —É–¥–∞—á–∏', desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∏ –Ω–∞ 10%', cost: 8, rarity: 'legendary', effect: { winMultiplier: 1.1 } },
            { id: 'money_magnet', name: '–î–µ–Ω–µ–∂–Ω—ã–π –º–∞–≥–Ω–∏—Ç', desc: '–°–∏–º–≤–æ–ª—ã üí∞ –¥–∞—é—Ç +2üí∞', cost: 4, rarity: 'rare', on_spin: (grid) => grid.filter(s => s.id === 'coins').length * 2 },
            { id: 'double_down', name: '–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –ì–ª–∞–∑', desc: '–£–¥–≤–∞–∏–≤–∞–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∏ —Å –ª–∏–Ω–∏–π –∏–∑ 5 —Å–∏–º–≤–æ–ª–æ–≤', cost: 7, rarity: 'legendary', effect: { five_in_row_multiplier: 2 } },
            { id: 'free_spin_coupon', name: '–ö—É–ø–æ–Ω –Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç', desc: '–î–∞–µ—Ç 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Ä—É—Ç', cost: 2, rarity: 'common', effect: { freeSpins: 1 } },
            { id: 'spin_pack', name: '–ü–∞–∫–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–æ–≤', desc: '–î–∞–µ—Ç 3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø—Ä–æ–∫—Ä—É—Ç–∞', cost: 5, rarity: 'rare', effect: { freeSpins: 3 } },
        ];

        let state = {};
        const weightedSymbols = SYMBOLS.flatMap(s => Array(s.weight).fill(s));
        
        function addLog(message, type = 'normal') {
            const logEntry = document.createElement('p');
            logEntry.textContent = `> ${message}`;
            if (type === 'win') logEntry.style.color = 'var(--highlight-color)';
            if (type === 'loss') logEntry.style.color = 'var(--danger-color)';
            ui.logPanel.insertBefore(logEntry, ui.logPanel.firstChild);
            if (ui.logPanel.children.length > 50) ui.logPanel.removeChild(ui.logPanel.lastChild);
        }

        function hasItem(itemId) { return state.inventory.some(item => item.id === itemId); }

        function getItemEffectValue(effectKey, defaultValue) {
            return state.inventory.reduce((acc, item) => {
                if (item.effect && item.effect[effectKey]) {
                    return effectKey.includes('Multiplier') ? acc * item.effect[effectKey] : acc + item.effect[effectKey];
                }
                return acc;
            }, defaultValue);
        }

        function generateGrid() {
            const luck = getItemEffectValue('luck', 0);
            let adjustedSymbols = [...SYMBOLS];
            
            // –£–¥–∞—á–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–µ—Å —Ü–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            if (luck > 0) {
                adjustedSymbols = adjustedSymbols.map(symbol => ({
                    ...symbol,
                    weight: symbol.weight + Math.floor(symbol.value * luck * 2)
                }));
                console.log(`Luck: ${luck}, Adjusted weights:`, adjustedSymbols.map(s => `${s.id}: ${s.weight}`));
            }
            
            const adjustedWeightedSymbols = adjustedSymbols.flatMap(s => Array(s.weight).fill(s));
            
            return Array.from({ length: CONFIG.ROWS * CONFIG.COLS }, () => 
                adjustedWeightedSymbols[Math.floor(Math.random() * adjustedWeightedSymbols.length)]
            );
        }

        function calculateWinnings() {
            const grid = state.grid;
            let totalWinnings = 0;
            const allWinningPositions = new Set();
            const winningLines = [];
            
            console.log('=== CALCULATE WINNINGS ===');
            console.log('Final grid state:', grid.map(s => s.id));
            
            PAYLINES.forEach(line => {
                console.log(`\nChecking line: ${line.name}, positions: ${line.positions}`);
                const symbolsOnLine = line.positions.map(pos => grid[pos]);
                console.log(`Symbols on line:`, symbolsOnLine.map(s => s.id));

                let i = 0;
                while (i < symbolsOnLine.length) {
                    const currentSymbol = symbolsOnLine[i];
                    if (!currentSymbol) {
                        i++;
                        continue;
                    }

                    // –ù–∞—Ö–æ–¥–∏–º –¥–ª–∏–Ω—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    let length = 1;
                    for (let j = i + 1; j < symbolsOnLine.length; j++) {
                        if (symbolsOnLine[j] && symbolsOnLine[j].id === currentSymbol.id) {
                            length++;
                        } else {
                            break;
                        }
                    }

                    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –≤—ã–∏–≥—Ä—ã—à–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è (3+ —Å–∏–º–≤–æ–ª–æ–≤)
                    if (length >= 3) {
                        const baseValue = currentSymbol.value;
                        const multiplier = {3: 1, 4: 2, 5: 5}[length] * (length === 5 ? getItemEffectValue('five_in_row_multiplier', 1) : 1);
                        const win = Math.floor(baseValue * multiplier * getItemEffectValue('winMultiplier', 1));
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                        const winningPositions = [];
                        for (let k = 0; k < length; k++) {
                            winningPositions.push(line.positions[i + k]);
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–∏–≥—Ä—ã—à–Ω–æ–π –ª–∏–Ω–∏–∏
                        winningLines.push({
                            name: line.name,
                            symbol: currentSymbol.id,
                            length: length,
                            win: win,
                            positions: winningPositions
                        });
                        
                        totalWinnings += win;
                        winningPositions.forEach(pos => allWinningPositions.add(pos));
                        
                        addLog(`${line.name} (${currentSymbol.id} x${length}): +${win}üí∞`, 'win');
                        console.log(`  WIN! ${line.name} (${currentSymbol.id} x${length}): +${win}üí∞`);

                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–Ω–¥–µ–∫—Å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ —Å—á–∏—Ç–∞—Ç—å –µ—ë —á–∞—Å—Ç–∏ —Å–Ω–æ–≤–∞
                        i += length;
                    } else {
                        // –ï—Å–ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–µ –≤—ã–∏–≥—Ä—ã—à–Ω–∞—è, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–∏–º–≤–æ–ª—É
                        i++;
                    }
                }
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–±–æ-–º–Ω–æ–∂–∏—Ç–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∏–≥—Ä—ã—à–∏
            if (winningLines.length > 1) {
                const comboMultiplier = Math.min(winningLines.length, 5); // –ú–∞–∫—Å–∏–º—É–º 5x –∑–∞ 5+ –ª–∏–Ω–∏–π
                const comboBonus = Math.floor(totalWinnings * (comboMultiplier - 1) * 0.5); // 50% –±–æ–Ω—É—Å –∑–∞ –∫–∞–∂–¥—É—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–∏–Ω–∏—é
                totalWinnings += comboBonus;
                addLog(`üî• –ö–û–ú–ë–û x${comboMultiplier}! –ë–æ–Ω—É—Å: +${comboBonus}üí∞`, 'win');
                console.log(`üî• COMBO x${comboMultiplier}! Bonus: +${comboBonus}üí∞`);
            }

            state.inventory.forEach(item => {
                if (item.on_spin) {
                    const bonus = item.on_spin(grid);
                    if (bonus > 0) { totalWinnings += bonus; addLog(`${item.name}: +${bonus}üí∞`, 'win'); }
                }
            });

            if (totalWinnings > 0) {
                state.coins += totalWinnings;
                highlightWinningCells(Array.from(allWinningPositions), totalWinnings);
            } else { 
                addLog('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ.'); 
                console.log('No wins found.');
            }
        }

        function highlightWinningCells(positions, winAmount) {
            const cells = ui.slotMachine.querySelectorAll('.slot-cell');
            let highlightClass = 'highlight';
            if (winAmount > 50) highlightClass = 'highlight-huge';
            else if (winAmount > 20) highlightClass = 'highlight-big';
            positions.forEach(pos => cells[pos]?.classList.add(highlightClass));
            setTimeout(() => cells.forEach(cell => cell.classList.remove('highlight', 'highlight-big', 'highlight-huge')), 2000);
        }

        function populateShop() {
            state.shop = [];
            const availableItems = [...ALL_ITEMS].filter(item => !hasItem(item.id));
            for (let i = 0; i < 3; i++) {
                if (availableItems.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableItems.length);
                    state.shop.push(availableItems[randomIndex]);
                    availableItems.splice(randomIndex, 1);
                }
            }
        }
        
        async function spin() {
            if (state.spinsLeft <= 0 || state.gameover || state.isSpinning) return;
            
            console.log('Spin started - isSpinning set to true');
            state.isSpinning = true;
            ui.lever.classList.add('pulled');
            state.spinsLeft--;
            updateUI(); 

            // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –î–û –Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
            state.grid = generateGrid();
            
            // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–∏—Ç –±–∞—Ä–∞–±–∞–Ω—ã –∏ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç –∏—Ö –∫ –Ω–æ–≤–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            await runSpinAnimation();
            
            // 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –≤–∏–¥–µ–Ω –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            calculateWinnings();
            updateUI();
            
            console.log('Spin finished - isSpinning set to false');
            state.isSpinning = false;
            ui.lever.classList.remove('pulled');
            updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ isSpinning
        }
        
        function initGame() {
            state = {
                run: 1, targetDebt: 50, turn: 1, coins: 20, bankBalance: 0, tickets: 5, luck: 0,
                spinsLeft: 0, baseInterestRate: 0.40, inventory: [], shop: [], gameover: false, isSpinning: false,
            };
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º grid –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ state
            state.grid = generateGrid();
            
            ui.startScreen.classList.add('hidden');
            ui.gameOverScreen.classList.add('hidden');
            ui.logPanel.innerHTML = '';
            
            // –ü–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
            renderGrid(true); 

            populateShop();
            addLog(`–ù–∞—á–∞–ª—Å—è –¶–∏–∫–ª –î–æ–ª–≥–∞ #${state.run}. –¶–µ–ª—å: ${state.targetDebt}üí∞ –∑–∞ 3 –¥–Ω—è.`);
            startTurn();
        }

        function applyPassiveEffects() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Å—Å–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ—Ç –∞–º—É–ª–µ—Ç–æ–≤
            const freeSpins = getItemEffectValue('freeSpins', 0);
            if (freeSpins > 0) {
                state.spinsLeft += freeSpins;
                addLog(`–ü–∞—Å—Å–∏–≤–Ω—ã–µ –∞–º—É–ª–µ—Ç—ã –¥–∞–ª–∏ +${freeSpins} –ø—Ä–æ–∫—Ä—É—Ç(–∞/–æ–≤)`, 'win');
            }
        }

        function startTurn() {
            // –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –Ω–∞—á–∞–ª–µ —Ä–∞—É–Ω–¥–∞ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞ –ø–µ—Ä–≤–æ–≥–æ —Ü–∏–∫–ª–∞)
            if (state.turn > 1) {
                const interest = Math.floor(state.bankBalance * state.baseInterestRate);
                console.log(`Debug: turn=${state.turn}, run=${state.run}, bankBalance=${state.bankBalance}, interestRate=${state.baseInterestRate}, calculatedInterest=${state.bankBalance * state.baseInterestRate}, finalInterest=${interest}`);
                if (interest > 0) {
                    state.coins += interest;
                    addLog(`–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫—ç—à–±–µ–∫: +${interest}üí∞.`, 'win');
                } else {
                    addLog(`–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫—ç—à–±–µ–∫: 0üí∞ (–±–∞–ª–∞–Ω—Å: ${state.bankBalance}üí∞, —Å—Ç–∞–≤–∫–∞: ${(state.baseInterestRate * 100).toFixed(1)}%)`);
                }
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Å—Å–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –≤ –Ω–∞—á–∞–ª–µ —Ä–∞—É–Ω–¥–∞
            applyPassiveEffects();
            
            ui.purchaseModalTitle.textContent = `–†–∞—É–Ω–¥ ${state.turn}. –í—Ä–µ–º—è –∑–∞–∫—É–ø–∞—Ç—å—Å—è.`;
            ui.purchaseModalCoins.textContent = `${state.coins}üí∞`;
            ui.btnBuySpins7.disabled = state.coins < CONFIG.SPIN_PACKAGE_1.cost;
            ui.btnBuySpins3.disabled = state.coins < CONFIG.SPIN_PACKAGE_2.cost;
            ui.spinPurchaseModal.classList.remove('hidden');
            updateUI();
        }
        
        function buySpins(pkg) {
            if (pkg) {
                if (state.coins >= pkg.cost) {
                    state.coins -= pkg.cost;
                    state.spinsLeft += pkg.spins;
                    state.tickets += pkg.tickets;
                    addLog(`–ö—É–ø–ª–µ–Ω–æ: ${pkg.spins} –ø—Ä–æ–∫—Ä—É—Ç–æ–≤ –∏ ${pkg.tickets} —Ç–∞–ª–æ–Ω(–∞/–æ–≤).`);
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Å—Å–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–æ–≤
                    const freeSpins = getItemEffectValue('freeSpins', 0);
                    if (freeSpins > 0) {
                        state.spinsLeft += freeSpins;
                        addLog(`–ü–∞—Å—Å–∏–≤–Ω—ã–µ –∞–º—É–ª–µ—Ç—ã –¥–∞–ª–∏ +${freeSpins} –ø—Ä–æ–∫—Ä—É—Ç(–∞/–æ–≤)`, 'win');
                    }
                } else { addLog(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö.`, 'loss'); }
            }
            ui.spinPurchaseModal.classList.add('hidden');
            updateUI();
        }

        function endTurn() {
            if (state.isSpinning) return;
            ui.eorTitle.textContent = `–ö–æ–Ω–µ—Ü –†–∞—É–Ω–¥–∞ ${state.turn}`;
            ui.eorCoins.textContent = `${state.coins}üí∞`;
            ui.eorBank.textContent = `${state.bankBalance}üí∞`;
            ui.eorDepositAmount.value = '';
            ui.endOfRoundModal.classList.remove('hidden');
        }

        function confirmEndTurn() {
            ui.endOfRoundModal.classList.add('hidden');
            addLog(`--- –†–∞—É–Ω–¥ ${state.turn} –æ–∫–æ–Ω—á–µ–Ω ---`);
            state.turn++;
            if (state.turn > 3) {
                judgementDay();
            } else {
                startTurn();
            }
        }

        function judgementDay() {
            const totalMoney = state.coins + state.bankBalance;
            addLog(`–°–£–î–ù–´–ô –î–ï–ù–¨. –í–∞—à–∞ —Å—É–º–º–∞: ${totalMoney}üí∞. –¢—Ä–µ–±—É–µ—Ç—Å—è: ${state.targetDebt}üí∞.`);
            if (totalMoney >= state.targetDebt) {
                const remainder = totalMoney - state.targetDebt;
                const rewardTickets = 5 + state.run;
                ui.judgementTitle.textContent = "–î–û–õ–ì –í–´–ü–õ–ê–ß–ï–ù";
                ui.judgementTitle.classList.remove('failure');
                ui.judgementText.innerHTML = `–í—ã –≤—ã–∂–∏–ª–∏. –û—Å—Ç–∞—Ç–æ–∫ <span style="color:var(--money-color)">${remainder}üí∞</span> –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ –±–∞–Ω–∫.<br>–ù–∞–≥—Ä–∞–¥–∞: <span style="color:var(--ticket-color)">${rewardTickets}üéüÔ∏è</span>.`;
                ui.judgementContinue.onclick = () => {
                    ui.judgementModal.classList.add('hidden');
                    state.run++;
                    state.turn = 1;
                    state.targetDebt = Math.floor(state.targetDebt * 1.8 + 20);
                    state.coins = 0;
                    state.bankBalance = remainder;
                    state.tickets += rewardTickets;
                    state.spinsLeft = 0;
                    addLog(`–ù–æ–≤—ã–π –¶–∏–∫–ª –î–æ–ª–≥–∞ #${state.run} –Ω–∞—á–∞–ª—Å—è. –¶–µ–ª—å: ${state.targetDebt}üí∞.`);
                    
                    // –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ–Ω—å–≥–∏ –≤ –±–∞–Ω–∫–µ
                    if (state.bankBalance > 0) {
                        const interest = Math.floor(state.bankBalance * state.baseInterestRate);
                        if (interest > 0) {
                            state.coins += interest;
                            addLog(`–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫—ç—à–±–µ–∫ –≤ –Ω–æ–≤–æ–º —Ü–∏–∫–ª–µ: +${interest}üí∞.`, 'win');
                        }
                    }
                    
                    populateShop();
                    startTurn();
                };
            } else {
                ui.judgementTitle.textContent = "–ü–†–û–í–ê–õ";
                ui.judgementTitle.classList.add('failure');
                ui.judgementText.textContent = `–í—ã –Ω–µ —Å–º–æ–≥–ª–∏ —Å–æ–±—Ä–∞—Ç—å –Ω—É–∂–Ω—É—é —Å—É–º–º—É. –Ø–º–∞ –∂–¥–µ—Ç.`;
                ui.judgementContinue.onclick = () => {
                    ui.judgementModal.classList.add('hidden');
                    gameOver();
                };
            }
            ui.judgementModal.classList.remove('hidden');
        }
        
        function gameOver() {
            state.gameover = true;
            ui.finalRun.textContent = state.run;
            ui.gameOverScreen.classList.remove('hidden');
            addLog("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê.", 'loss');
        }
        
        function deposit(amount, isFromEOR = false) {
            if (isNaN(amount) || amount <= 0) return addLog("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞.", 'loss');
            if (amount > state.coins) return addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö.", 'loss');
            state.coins -= amount;
            state.bankBalance += amount;
            addLog(`–í–Ω–µ—Å–µ–Ω–æ –≤ –±–∞–Ω–∫: ${amount}üí∞.`);
            if (isFromEOR) {
                ui.eorDepositAmount.value = '';
                ui.eorCoins.textContent = `${state.coins}üí∞`;
                ui.eorBank.textContent = `${state.bankBalance}üí∞`;
            }
            ui.depositAmountInput.value = ''; // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞
            updateUI();
        }

        function rerollShop() {
            if (state.tickets >= CONFIG.REROLL_COST) {
                state.tickets -= CONFIG.REROLL_COST;
                populateShop();
                addLog(`–ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –∑–∞ ${CONFIG.REROLL_COST}üéüÔ∏è.`);
                updateUI();
            } else { addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∞–ª–æ–Ω–æ–≤.', 'loss'); }
        }

        function buyItem(itemId) {
            const item = state.shop.find(i => i.id === itemId);
            if (!item || state.tickets < item.cost) return addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∞–ª–æ–Ω–æ–≤.', 'loss');
            state.tickets -= item.cost;
            state.inventory.push(item);
            state.shop = state.shop.filter(i => i.id !== itemId);
            addLog(`–ö—É–ø–ª–µ–Ω –∞–º—É–ª–µ—Ç: ${item.name}`, 'win');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –≥–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è
            if (ui.planningModal.classList.contains('hidden')) {
                updateUI();
            } else {
                ui.planningTickets.textContent = state.tickets;
                renderPlanningShop();
                renderPlanningInventory();
                updateUI();
            }
        }
        
        function updateUI() {
            ui.statRun.textContent = state.run;
            ui.statTurn.textContent = `${state.turn} / 3`;
            ui.statDebt.textContent = `${state.targetDebt}üí∞`;
            ui.statCoins.textContent = `${state.coins}üí∞`;
            ui.bankBalance.textContent = `${state.bankBalance}üí∞`;
            ui.statTickets.textContent = `${state.tickets}üéüÔ∏è`;
            ui.statLuck.textContent = state.luck + getItemEffectValue('luck', 0);
            ui.spinsLeft.textContent = state.spinsLeft;
            ui.atmInterestRate.textContent = (state.baseInterestRate * 100).toFixed(0);
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log(`UI Debug - isSpinning: ${state.isSpinning}, spinsLeft: ${state.spinsLeft}`);
            ui.btnEndTurn.disabled = state.isSpinning || state.spinsLeft > 0;
            
            ui.btnRerollShop.textContent = `Reroll (${CONFIG.REROLL_COST}üéüÔ∏è)`;
            renderInventory(); 
            renderShop();
        }
        
        function renderGrid(isInitialSetup = false) {
            if (!isInitialSetup) return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞

            ui.slotMachine.innerHTML = '';
            for (let i = 0; i < CONFIG.ROWS * CONFIG.COLS; i++) {
                const cell = document.createElement('div');
                cell.className = 'slot-cell';
                
                const reel = document.createElement('div');
                reel.className = 'reel';
                cell.appendChild(reel);
                
                ui.slotMachine.appendChild(cell);
            }
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            updateReels(true);
        }

        function updateReels(isInitial = false) {
            const reels = ui.slotMachine.querySelectorAll('.reel');
            const finalGrid = state.grid;

            reels.forEach((reel, i) => {
                reel.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–∏–º–≤–æ–ª—ã
                
                const reelSymbols = [];
                for (let j = 0; j < 19; j++) {
                    reelSymbols.push(weightedSymbols[Math.floor(Math.random() * weightedSymbols.length)]);
                }
                reelSymbols.push(finalGrid[i]); // –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π

                reelSymbols.forEach(symbol => {
                    const symbolDiv = document.createElement('div');
                    symbolDiv.className = 'symbol';
                    symbolDiv.textContent = symbol.graphic;
                    reel.appendChild(symbolDiv); 
                });

                if (isInitial) {
                    reel.style.transition = 'none';
                    reel.style.transform = `translateY(-95%)`;
                }
            });
        }
        
        async function runSpinAnimation() {
            // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∞—Ä–∞–±–∞–Ω–æ–≤ –Ω–æ–≤—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
            updateReels(false);

            const reels = ui.slotMachine.querySelectorAll('.reel');
            const promises = [];
            
            reels.forEach((reel, i) => {
                // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞–≤–µ—Ä—Ö –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
                reel.style.transition = 'none';
                reel.style.transform = 'translateY(0)';
                reel.offsetHeight; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π

                // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É
                const delay = (i % CONFIG.COLS) * 100;
                promises.push(new Promise(resolve => {
                    setTimeout(() => {
                        reel.style.transition = `transform ${CONFIG.SPIN_ANIMATION_TIME / 1000}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                        reel.style.transform = `translateY(-95%)`;
                        resolve();
                    }, delay);
                }));
            });
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π
            await Promise.all(promises);
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            await new Promise(res => setTimeout(res, CONFIG.SPIN_ANIMATION_TIME + (CONFIG.COLS - 1) * 100));
        }

        function renderShop() {
            ui.shopItems.innerHTML = '';
            if (state.shop.length === 0) ui.shopItems.innerHTML = '<p style="text-align:center; color: #777;">–ü—É—Å—Ç–æ</p>';
            state.shop.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item rarity-${item.rarity}`;
                itemDiv.onclick = () => buyItem(item.id);
                itemDiv.innerHTML = `<span class="item-cost">${item.cost}üéüÔ∏è</span><span class="item-name">${item.name}</span><p class="item-desc">${item.desc}</p>`;
                if (state.tickets < item.cost) itemDiv.style.opacity = '0.5';
                ui.shopItems.appendChild(itemDiv);
            });
        }

        function renderInventory() {
            ui.inventoryItems.innerHTML = '';
            if (state.inventory.length === 0) ui.inventoryItems.innerHTML = '<p style="text-align:center; color: #777;">–ü—É—Å—Ç–æ</p>';
            state.inventory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item rarity-${item.rarity}`;
                itemDiv.style.cursor = 'default';
                itemDiv.innerHTML = `<span class="item-name">${item.name}</span><p class="item-desc">${item.desc}</p>`;
                ui.inventoryItems.appendChild(itemDiv);
            });
        }

        function openPlanningMode() {
            ui.spinPurchaseModal.classList.add('hidden');
            ui.planningModal.classList.remove('hidden');
            ui.planningTickets.textContent = state.tickets;
            renderPlanningShop();
            renderPlanningInventory();
        }

        function closePlanningMode() {
            ui.planningModal.classList.add('hidden');
            ui.spinPurchaseModal.classList.remove('hidden');
        }

        function renderPlanningShop() {
            ui.planningShopItems.innerHTML = '';
            if (state.shop.length === 0) ui.planningShopItems.innerHTML = '<p style="text-align:center; color: #777;">–ü—É—Å—Ç–æ</p>';
            state.shop.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item rarity-${item.rarity}`;
                itemDiv.onclick = () => buyItem(item.id);
                itemDiv.innerHTML = `<span class="item-cost">${item.cost}üéüÔ∏è</span><span class="item-name">${item.name}</span><p class="item-desc">${item.desc}</p>`;
                if (state.tickets < item.cost) itemDiv.style.opacity = '0.5';
                ui.planningShopItems.appendChild(itemDiv);
            });
        }

        function renderPlanningInventory() {
            ui.planningInventoryItems.innerHTML = '';
            if (state.inventory.length === 0) ui.planningInventoryItems.innerHTML = '<p style="text-align:center; color: #777;">–ü—É—Å—Ç–æ</p>';
            state.inventory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item rarity-${item.rarity}`;
                itemDiv.style.cursor = 'default';
                itemDiv.innerHTML = `<span class="item-name">${item.name}</span><p class="item-desc">${item.desc}</p>`;
                ui.planningInventoryItems.appendChild(itemDiv);
            });
        }

        function rerollPlanningShop() {
            if (state.tickets >= CONFIG.REROLL_COST) {
                state.tickets -= CONFIG.REROLL_COST;
                populateShop();
                addLog(`–ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –∑–∞ ${CONFIG.REROLL_COST}üéüÔ∏è.`);
                ui.planningTickets.textContent = state.tickets;
                renderPlanningShop();
                updateUI();
            } else { addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∞–ª–æ–Ω–æ–≤.', 'loss'); }
        }

        // --- –°–û–ë–´–¢–ò–Ø ---
        ui.btnStartGame.onclick = initGame;
        ui.btnRestartGame.onclick = initGame;
        ui.lever.onclick = spin;
        ui.btnDeposit.onclick = () => deposit(parseInt(ui.depositAmountInput.value, 10), false);
        ui.btnEndTurn.onclick = endTurn;
        ui.btnConfirmEndTurn.onclick = confirmEndTurn;
        ui.btnEorDeposit.onclick = () => deposit(parseInt(ui.eorDepositAmount.value, 10), true);
        ui.btnBuySpins7.onclick = () => buySpins(CONFIG.SPIN_PACKAGE_1);
        ui.btnBuySpins3.onclick = () => buySpins(CONFIG.SPIN_PACKAGE_2);
        ui.btnBuyNothing.onclick = () => buySpins(null);
        ui.btnRerollShop.onclick = rerollShop;
        ui.btnPlanning.onclick = openPlanningMode;
        ui.btnPlanningReroll.onclick = rerollPlanningShop;
        ui.btnFinishPlanning.onclick = closePlanningMode;

        ui.startScreen.classList.remove('hidden');
    });
    </script>
</body>
</html>