<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ç—É–ª—Ç–∏–ø–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-item {
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .test-item:hover {
            background: #444;
        }
        .test-controls {
            margin: 20px 0;
            padding: 15px;
            background: #222;
            border-radius: 8px;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç—É–ª—Ç–∏–ø–æ–≤</h1>
        
        <div class="info">
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</h3>
            <ul>
                <li>–ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∏–∂–µ –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤</li>
                <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –±—ã—Å—Ç—Ä–æ –¥–≤–∏–≥–∞—Ç—å –º—ã—à—å—é –º–µ–∂–¥—É –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤</li>
                <li>–ù–∞–∂–º–∏—Ç–µ Escape –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö —Ç—É–ª—Ç–∏–ø–æ–≤</li>
            </ul>
        </div>

        <div class="test-controls">
            <button onclick="hideAllTooltips()">–°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç—É–ª—Ç–∏–ø—ã</button>
            <button onclick="testMultipleTooltips()">–¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç—É–ª—Ç–∏–ø–æ–≤</button>
            <button onclick="testRapidHover()">–¢–µ—Å—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—è</button>
        </div>

        <div id="test-items">
            <div class="test-item" data-item='{"name":"–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 1","desc":"–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞","cost":5}'>
                üß™ –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 1 (5üéüÔ∏è)
            </div>
            <div class="test-item" data-item='{"name":"–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 2","desc":"–û–ø–∏—Å–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ —Å –¥–ª–∏–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–µ–∑–∫–∏","cost":3}'>
                üîÆ –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 2 (3üéüÔ∏è)
            </div>
            <div class="test-item" data-item='{"name":"–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 3","desc":"–û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ—Ç—å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞","cost":7}'>
                ‚ö° –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 3 (7üéüÔ∏è)
            </div>
            <div class="test-item" data-item='{"name":"–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 4","desc":"–ï—â–µ –æ–¥–∏–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç","cost":2}'>
                üéØ –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 4 (2üéüÔ∏è)
            </div>
            <div class="test-item" data-item='{"name":"–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 5","desc":"–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç","cost":10}'>
                üíé –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç 5 (10üéüÔ∏è)
            </div>
        </div>
    </div>

    <script>
        // –ò–º–∏—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        function createItemTooltip(item, currentCost, oldCost) {
            const tooltip = document.createElement('div');
            tooltip.className = 'item-tooltip';
            
            let costHTML = '';
            if (item.cost) {
                costHTML = `${currentCost}üéüÔ∏è`;
                if (oldCost && currentCost < oldCost) {
                    costHTML += ` <s style="opacity:0.6">${oldCost}üéüÔ∏è`;
                }
            }
            
            tooltip.innerHTML = `
                <div class="item-tooltip-header">
                    <div class="item-tooltip-thumbnail">üß™</div>
                    <div class="item-tooltip-title">${item.name}</div>
                    ${costHTML ? `<div class="item-tooltip-cost">${costHTML}</div>` : ''}
                </div>
                <div class="item-tooltip-desc">${item.desc}</div>
            `;
            
            return tooltip;
        }

        function positionTooltip(tooltip, event) {
            if (!tooltip || !tooltip.parentNode) return;
            
            const rect = tooltip.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                tooltip.style.visibility = 'hidden';
                tooltip.style.display = 'block';
                const tempRect = tooltip.getBoundingClientRect();
                tooltip.style.visibility = '';
                tooltip.style.display = '';
                
                if (tempRect.width === 0 || tempRect.height === 0) {
                    const vw = window.innerWidth;
                    const vh = window.innerHeight;
                    
                    let tooltipLeft = event.clientX + 15;
                    let tooltipTop = event.clientY - 10;
                    
                    if (tooltipLeft + 320 > vw - 20) {
                        tooltipLeft = event.clientX - 320 - 15;
                    }
                    if (tooltipLeft < 20) {
                        tooltipLeft = 20;
                    }
                    if (tooltipTop + 200 > vh - 20) {
                        tooltipTop = event.clientY - 200 - 10;
                    }
                    if (tooltipTop < 20) {
                        tooltipTop = 20;
                    }
                    
                    tooltip.style.left = tooltipLeft + 'px';
                    tooltip.style.top = tooltipTop + 'px';
                    return;
                }
            }
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left = event.clientX + 15;
            let top = event.clientY - 10;
            
            if (left + rect.width > viewportWidth - 20) {
                left = event.clientX - rect.width - 15;
            }
            if (left < 20) {
                left = 20;
            }
            if (top + rect.height > viewportHeight - 20) {
                top = event.clientY - rect.height - 10;
            }
            if (top < 20) {
                top = 20;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideAllTooltips() {
            const tooltips = document.querySelectorAll('.item-tooltip');
            tooltips.forEach(tooltip => {
                if (tooltip.parentNode) {
                    tooltip.classList.remove('show');
                    setTimeout(() => {
                        if (tooltip && tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                    }, 200);
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        document.querySelectorAll('.test-item').forEach(itemDiv => {
            let tooltip = null;
            let tooltipTimeout = null;
            
            const hideTooltip = () => {
                if (tooltipTimeout) {
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = null;
                }
                if (tooltip) {
                    tooltip.classList.remove('show');
                    setTimeout(() => {
                        if (tooltip && tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                        tooltip = null;
                    }, 200);
                }
            };
            
            itemDiv.addEventListener('mouseenter', (e) => {
                hideAllTooltips();
                
                if (!tooltip) {
                    try {
                        const itemData = JSON.parse(itemDiv.dataset.item);
                        tooltip = createItemTooltip(itemData, itemData.cost, null);
                        if (tooltip) {
                            document.body.appendChild(tooltip);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É–ª—Ç–∏–ø–∞:', error);
                        tooltip = null;
                        return;
                    }
                }
                
                tooltipTimeout = setTimeout(() => {
                    if (tooltip && tooltip.parentNode) {
                        tooltip.classList.add('show');
                    }
                }, 300);
                
                if (tooltip) {
                    positionTooltip(tooltip, e);
                }
            });
            
            itemDiv.addEventListener('mousemove', (e) => {
                if (tooltip && tooltip.parentNode) {
                    positionTooltip(tooltip, e);
                }
            });
            
            itemDiv.addEventListener('mouseleave', hideTooltip);
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.item-tooltip') && !e.target.closest('.test-item')) {
                hideAllTooltips();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideAllTooltips();
            }
        });

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function testMultipleTooltips() {
            const items = document.querySelectorAll('.test-item');
            items.forEach((item, index) => {
                setTimeout(() => {
                    const event = new MouseEvent('mouseenter', {
                        clientX: item.getBoundingClientRect().left + 50,
                        clientY: item.getBoundingClientRect().top + 20
                    });
                    item.dispatchEvent(event);
                }, index * 100);
            });
        }

        function testRapidHover() {
            const items = document.querySelectorAll('.test-item');
            let currentIndex = 0;
            const interval = setInterval(() => {
                hideAllTooltips();
                const item = items[currentIndex];
                const event = new MouseEvent('mouseenter', {
                    clientX: item.getBoundingClientRect().left + 50,
                    clientY: item.getBoundingClientRect().top + 20
                });
                item.dispatchEvent(event);
                
                currentIndex = (currentIndex + 1) % items.length;
                
                if (currentIndex === 0) {
                    clearInterval(interval);
                }
            }, 200);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        window.hideAllTooltips = hideAllTooltips;
    </script>

    <style>
        .item-tooltip {
            position: absolute;
            background: #333;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 16px;
            max-width: 320px;
            min-width: 280px;
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            pointer-events: none;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s ease, transform 0.2s ease;
            will-change: opacity, transform;
            contain: layout style paint;
            max-height: calc(100vh - 40px);
            overflow: hidden;
        }

        .item-tooltip.show {
            opacity: 1;
            transform: scale(1);
        }

        .item-tooltip.hidden {
            opacity: 0 !important;
            transform: scale(0.9) !important;
            pointer-events: none !important;
        }

        .item-tooltip.fade-out {
            opacity: 0 !important;
            transform: scale(0.9) !important;
            transition: opacity 0.15s ease, transform 0.15s ease !important;
        }

        .item-tooltip-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #555;
        }

        .item-tooltip-thumbnail {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: #444;
            border: 1px solid #555;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .item-tooltip-title {
            font-weight: bold;
            font-size: 16px;
            color: #fff;
            flex-grow: 1;
        }

        .item-tooltip-cost {
            font-weight: bold;
            color: #ffd700;
            font-size: 14px;
        }

        .item-tooltip-desc {
            margin-bottom: 12px;
            color: #ccc;
            opacity: 0.9;
        }
    </style>
</body>
</html> 